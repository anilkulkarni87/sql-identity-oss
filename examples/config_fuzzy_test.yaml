project_name: "fuzzy_demo"
schema_source: "retail"
schema_output: "idr_out"

sources:
  - id: "digital"
    table: "digital_customer_account"
    entity_key: "customer_id"
    watermark_column: "created_at"
    attributes:
      - name: "email"
        type: "EMAIL"
        expr: "email"
      - name: "phone"
        type: "PHONE"
        expr: "phone"
      - name: "first_name"
        type: "NAME"
        expr: "first_name"
      - name: "last_name"
        type: "NAME"
        expr: "last_name"

  - id: "pos"
    table: "pos_customer"
    entity_key: "customer_id"
    watermark_column: "created_at"
    attributes:
      - name: "email"
        type: "EMAIL"
        expr: "email"
      - name: "phone"
        type: "PHONE"
        expr: "phone"
      - name: "first_name"
        type: "NAME"
        expr: "first_name"
      - name: "last_name"
        type: "NAME"
        expr: "last_name"

rules:
  - id: 1
    name: "Exact Email"
    type: "EXACT"
    match_keys: ["email"]

  - id: 2
    name: "Exact Phone"
    type: "EXACT"
    match_keys: ["phone"]

fuzzy_rules:
  - rule_id: 3
    name: "Fuzzy Name Match (Jaro-Winkler)"
    blocking_key: "substring(last_name, 1, 1)"
    score_expr: "jaro_winkler_similarity(<a>.first_name, <b>.first_name)"
    threshold: 0.60

  - rule_id: 4
    name: "Fuzzy Email Typo Match"
    blocking_key: "substring(last_name, 1, 1)"
    score_expr: "jaro_winkler_similarity(<a>.email, <b>.email)"
    threshold: 0.80
